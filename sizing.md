# Sizing Evaluation

In an effort to determine the scope and estimate cost, feasibility, etc. of this project, some level of sizing analysis
is necessary. The primary concerns are, as always, cost and time. Since this is a hobby project undertaken for fun, I 
will not be assigning a cost to the time, however, I will be making coarse estimates of it to determine things like how
long it will practically take to assemble the device in the context of day job, family life, etc.

## Sizing Inputs
- Synthesized design
  - This will determine the logic gate count and paired with chosen logic implementation (CMOS, NMOS, TTL, etc) will 
    determine a rough estimate of transistor and supporting passive component count
    - Factors into estimates of parts cost, power sizing, parts handling/soldering time, and PCB area sizing 
- Transistor package dimensions
  - Dimensions of some common SMT transistor package types can help determine a lower bound on PCB area 

## Sizing Process
To begin the sizing estimation, the most straight forward method is to synthesize the design for a target FPGA. While 
different FPGAs will result in slightly different implementations, particularly when it comes to LUTs, I am working 
under the assumption that for estimation purposes, they will be close enough. The table at https://github.com/olofk/serv
showing the LUT and FF count for 3 different vendors suggests that at most, a factor of 2 variance exists. While 
potentially substantial, it's at least not an order of magnitude or more. 

Using the gate implementation LUTs and Flip-Flops for an FPGA implementation is going to result in an overestimation of 
what could be managed by implementing the discrete logic functions in their minimal/ideal form. Similar to the variance
error between synthesized designs for specific FPGAs, this error is considered acceptable. First and foremost, if the 
overestimate is acceptable, than the optimized form would certainly be. Secondly, it its entirely likely that the
design of the physical implementation will follow in the track of FPGA design (LUTs and Flip-Flops) for equivalent 
reasoning: while they may require more gates overall, it's far simpler to adjust static configurations of 10k equivalent 
structures than to have, say, 7k unique ones.

Given that the ultimate goal is to build a functioning SoC which can execute a program in some form, the Servant 
reference SoC implementation seems like the logical choice to check the scaling of. It can handle the minimum necessary
feature set to execute a basic Zephyr RTOS program and provides a UART and GPIO pin. Even if additional functionality
was added, it will provide a solid baseline for size estimation of a usable SoC.

## Synthesis
Since what limited experience I have with FPGAs and their tooling is with AMD/Xilinx UltraScale+ chips, I opted to 
synthesize the Servant design for its ZCU106 target. Utilization reported by Vivado for this chip is:

|    Type    | Used | Functional Category | Ignored | Reason                                              |
|:----------:|:----:|:-------------------:|:-------:|-----------------------------------------------------|
|   FDRE	    | 239	 |      Register       |    N    |                                                     |
|    LUT6    | 106  |         CLB         |    N    |                                                     |
|   LUT5	    |  62  |         CLB         |    N    |                                                     |
|   LUT4	    |  42  |         CLB         |    N    |                                                     |
|   LUT2	    |  42  |         CLB         |    N    |                                                     |
|  RAMD64E   |  36  |         CLB         |    Y    | Commercial RAM expected to be used                  |
|   LUT3	    |  24  |         CLB         |    N    |                                                     |
|   MUXF7    |  17  |         CLB         |    Y    | 16 used in Registry File RAM                        |
|   MUXF8    |  8   |         CLB         |    Y    | Used in Registry File RAM                           |
|   CARRY8   |  8   |         CLB         |    N    | Used in Timer                                       |
|    LUT1    |  4   |         CLB         |    N    |                                                     |
|  RAMB36E2  |  2   |      BLOCKRAM       |    Y    | Commercial RAM expected to be used                  |
|    OBUF    |  2   |         I/O         |    N    | GPIO pin buffers                                    |
|  SRLC32E   |  1   |         CLB         |    ?    | Need to identify use                                |
| MMCME4_ADV |  1   |        Clock        |    Y    | All clocks will be generated by supporting hardware |
|  IBUFCTRL  |  1   |       Others        |    Y    | Inputs will not be muxable/configurable             |
| DIFFINBUF  |  1   |         I/O         |    Y    | FPGA Specific hardware for clock input pins         |
|   BUFGCE   |  1   |        Clock        |    Y    | FPGA Specific handling of master clock enable       |

## Component Estimation
With this information, I can now make a calculation of gate/transistor count. For the purposes of this estimation, I 
will assume implementation is with CMOS NAND logic. There are several reasons for this evaluated [here](logic_types.md), 
but suffice it to say, if anything this will represent the high side of the estimation. 

In the table below, each component is for the purposes of calculation, broken down into some number of base elements, 
from which the gate and transistor count can be computed. In the case of LUTs, they will be broken down into an
appropriate count of 2:1 multiplexers. Buffers are treated as 2 NAND gates (acting as inverters in a line) and MUX 
elements are broken down into some number of 2:1 MUX units. Flip-Flops are treated directly as they are and the CARRY8
units are a mix of 5 2:1 MUX units and 4 XOR gates.

### Basic Unit to NAND Gates
| Basic Unit | NAND Gates |
|:----------:|:----------:|
|    FDRE    |     9      |
|  2:1 MUX   |     4      | 
|    BUF     |     2      |
|   CARRY8   |     36     |

Some components used in the estimation have counts which are higher than what is needed due to being used in interfacing 
with other FPGA components such as clocks and RAM. We will be removing these counts from the estimate.

### Components to Remove
| Component | Count |
|:---------:|:-----:|
|   FDRE    |   4   |
|   LUT6    |   0   |
|   LUT5    |  23   |
|   LUT4    |   3   |
|   LUT3    |   2   |
|   LUT2    |   0   |
|   LUT1    |   0   |
|  CARRY8   |   0   |


### Components to Transistors
| Component | Count | Basic Unit Count (# per) | NAND Gate Count | Transistor Count (N/P Type) |
|:---------:|:-----:|:------------------------:|:---------------:|:---------------------------:|
|   FDRE    |  235  |         235 (1)          |      2151       |          4302/4302          |
|   LUT6    |  106  |        6678 (63)         |      26712      |         53424/53424         |
|   LUT5    |  39   |        1209 (31)         |      4836       |          9672/9672          |
|   LUT4    |  39   |         585 (15)         |      2340       |          4680/4680          |
|   LUT3    |  22   |         154 (7)          |       616       |          1232/1232          |
|   LUT2    |  42   |         126 (3)          |       504       |          1008/1008          |
|   LUT1    |   4   |          4 (1)           |       16        |            32/32            |
|   OBUF    |   2   |          2 (1)           |        4        |             8/8             |
|  CARRY8   |   8   |       40/32 (5/4)        |       288       |           576/576           |

### Components used in Timer
| Component | Count |
|:---------:|:-----:|
|   FDRE    |  65   |
|   LUT6    |   0   |
|   LUT5    |   0   |
|   LUT4    |   0   |
|   LUT3    |   0   |
|   LUT2    |  32   |
|   LUT1    |   1   |
|  CARRY8   |   8   |

### Components to Transistors (Without Timer)
| Component | Count | Basic Unit Count (# per) | NAND Gate Count | Transistor Count (N/P Type) |
|:---------:|:-----:|:------------------------:|:---------------:|:---------------------------:|
|   FDRE    |  170  |         170 (1)          |      1530       |          3060/3060          |
|   LUT6    |  106  |        6678 (63)         |      26712      |         53424/53424         |
|   LUT5    |  39   |        1209 (31)         |      4836       |          9672/9672          |
|   LUT4    |  39   |         585 (15)         |      2340       |          4680/4680          |
|   LUT3    |  22   |         154 (7)          |       616       |          1232/1232          |
|   LUT2    |  10   |          30 (3)          |       120       |           240/240           |
|   LUT1    |   3   |          3 (1)           |       12        |            24/24            |
|   OBUF    |   2   |          2 (1)           |        4        |             8/8             |
|  CARRY8   |   0   |            0             |        0        |              0              |

### Total Gate/Transistor Count
| Variant  | NAND Gate Count | Transistor Count (N/P Type) |
|:--------:|:---------------:|:---------------------------:|
|  Timer   |      37179      |         74934/74934         |
| No Timer |      36170      |         72340/72340         |

## Analysis

With gate and transistor counts, we can now evaluate the cost, time, and area estimates. 

### Component Costs
For component cost estimation, we will assume purchasing at volumes that meet as well as exceed needed counts and the 
per-unit pricing at this volume is listed.

| Component |                                        Example Unit                                        | Count | Minimum Volume Unit Cost | Excessive Volume Unit Cost | Minimum Volume Total Cost | Excessive Volume Total Cost |
|:---------:|:------------------------------------------------------------------------------------------:|:-----:|:------------------------:|:--------------------------:|:-------------------------:|:---------------------------:|
| 4CH NAND  | https://www.digikey.com/en/products/detail/rochester-electronics-llc/MC74VHC00M/12128029 | 9294  |          $0.06           |           $0.06            |          $557.64          |           $557.64           |


From this evaluation alone, the cost is prohibitively high, implying a different set of conditions for the
implementation will be necessary.
